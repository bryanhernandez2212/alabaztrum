<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decants - ALABAZTRUM</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-white">
    {% include 'partials/navbar.html' %}

    <main class="min-h-screen py-2 bg-gray-50" style="min-height: 100vh; overflow-x: hidden;">
        <div class="container mx-auto px-4">
            <!-- Header con ordenamiento -->
            <div class="mb-2 flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Decants</h1>
                </div>
                <!-- Filtros de ordenamiento -->
                <div class="flex items-center gap-2">
                    <label class="text-xs text-gray-600 font-medium">Ordenar por:</label>
                    <div class="relative">
                        <select id="sort-select" class="appearance-none px-4 py-2 pr-8 bg-white border border-gray-300 rounded-lg text-sm text-gray-900 font-medium focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 cursor-pointer hover:border-gray-400 transition-all shadow-sm">
                            <option value="relevance">Relevancia</option>
                            <option value="price-asc">Menor precio</option>
                            <option value="price-desc">Mayor precio</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                            <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <!-- Barra lateral de filtros -->
                <aside class="hidden lg:block w-52 flex-shrink-0">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-3 sticky top-32">
                        <h2 class="text-sm font-bold text-gray-900 mb-3">Filtros</h2>
                        
                        <!-- Filtro por Género -->
                        <div class="mb-3">
                            <h3 class="text-xs font-semibold text-gray-900 mb-1.5">Género</h3>
                            <div class="space-y-1.5">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="gender" value="all" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900" checked>
                                    <span class="text-sm text-gray-700">Todos</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="gender" value="mujer" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900">
                                    <span class="text-sm text-gray-700">Mujer</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="gender" value="hombre" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900">
                                    <span class="text-sm text-gray-700">Hombre</span>
                                </label>
                            </div>
                        </div>

                        <!-- Filtro por Tamaño -->
                        <div class="mb-3">
                            <h3 class="text-xs font-semibold text-gray-900 mb-1.5">Tamaño</h3>
                            <div class="space-y-1.5">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="size" value="5ml" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900 filter-checkbox">
                                    <span class="text-sm text-gray-700">5ml</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="size" value="10ml" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900 filter-checkbox">
                                    <span class="text-sm text-gray-700">10ml</span>
                                </label>
                            </div>
                        </div>

                        <!-- Filtro por Marca -->
                        <div class="mb-3">
                            <h3 class="text-xs font-semibold text-gray-900 mb-1.5">Marca</h3>
                            <div id="brands-filter" class="space-y-1.5 max-h-36 overflow-y-auto">
                                <div class="text-gray-400 text-sm">Cargando marcas...</div>
                            </div>
                        </div>

                        <!-- Filtro por Tipo de Fragancia -->
                        <div class="mb-3">
                            <h3 class="text-xs font-semibold text-gray-900 mb-1.5">Tipo de Fragancia</h3>
                            <div id="fragrance-types-filter" class="space-y-1.5 max-h-36 overflow-y-auto">
                                <div class="text-gray-400 text-sm">Cargando tipos...</div>
                            </div>
                        </div>

                        <!-- Botón limpiar filtros -->
                        <button id="clear-filters" class="w-full px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition font-medium text-xs mt-2">
                            Limpiar Filtros
                        </button>
                    </div>
                </aside>

                <!-- Contenido principal -->
                <div class="flex-1">
                    <!-- Grid de productos -->
                    <div id="products-container" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-2 sm:gap-3">
                        <!-- Los productos se cargarán aquí dinámicamente -->
                        <div class="col-span-full text-center py-12">
                            <div class="flex flex-col items-center">
                                <div class="bg-gray-100 rounded-full p-4 mb-3">
                                    <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                                </div>
                                <p class="text-gray-600 font-medium">Cargando decants...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts Firebase y autenticación -->
    <script src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/navbar-auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/navbar-persistent.js') }}"></script>
    
    <script>
        let allProducts = [];
        let allBrands = [];
        let allFragranceTypes = [];
        let activeFilters = {
            gender: [],
            size: [],
            brand: [],
            fragranceType: []
        };
        let currentSort = 'relevance';

        // Cargar productos (solo decants)
        async function loadProducts() {
            try {
                if (typeof db === 'undefined') {
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            loadProducts().then(resolve);
                        }, 500);
                    });
                }

                const productsSnapshot = await db.collection('products').where('isDecant', '==', true).orderBy('name').get();
                allProducts = [];
                const brandsSet = new Set();
                const typesSet = new Set();
                
                productsSnapshot.forEach((doc) => {
                    const product = doc.data();
                    allProducts.push({
                        id: doc.id,
                        ...product
                    });
                    
                    if (product.brand) brandsSet.add(product.brand);
                    if (product.fragranceType) typesSet.add(product.fragranceType);
                });

                allBrands = Array.from(brandsSet).sort();
                allFragranceTypes = Array.from(typesSet).sort();

                loadFilters();
            } catch (error) {
                console.error('Error al cargar productos:', error);
                document.getElementById('products-container').innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="flex flex-col items-center">
                            <div class="bg-red-100 rounded-full p-4 mb-3">
                                <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                            </div>
                            <p class="text-red-600 font-medium mb-1">Error al cargar productos</p>
                            <p class="text-gray-500 text-sm">Por favor, intenta recargar la página</p>
                        </div>
                    </div>
                `;
            }
        }

        // Cargar filtros
        function loadFilters() {
            // Cargar marcas
            const brandsContainer = document.getElementById('brands-filter');
            if (allBrands.length > 0) {
                brandsContainer.innerHTML = allBrands.map(brand => `
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" name="brand" value="${brand}" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900 filter-checkbox">
                        <span class="text-sm text-gray-700">${brand}</span>
                    </label>
                `).join('');
            } else {
                brandsContainer.innerHTML = '<div class="text-gray-400 text-sm">No hay marcas disponibles</div>';
            }

            // Cargar tipos de fragancia
            const typesContainer = document.getElementById('fragrance-types-filter');
            if (allFragranceTypes.length > 0) {
                typesContainer.innerHTML = allFragranceTypes.map(type => `
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" name="fragranceType" value="${type}" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900 filter-checkbox">
                        <span class="text-sm text-gray-700">${type}</span>
                    </label>
                `).join('');
            } else {
                typesContainer.innerHTML = '<div class="text-gray-400 text-sm">No hay tipos disponibles</div>';
            }

            // Agregar event listeners a los checkboxes
            document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateFilters);
            });

            // Event listener para los checkboxes de género
            document.querySelectorAll('input[name="gender"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.value === 'all' && this.checked) {
                        document.querySelectorAll('input[name="gender"]:not([value="all"])').forEach(cb => cb.checked = false);
                    } else if (this.value !== 'all' && this.checked) {
                        document.querySelector('input[name="gender"][value="all"]').checked = false;
                    }
                    updateFilters();
                });
            });
        }

        // Actualizar filtros activos
        function updateFilters() {
            // Género
            const genderCheckboxes = document.querySelectorAll('input[name="gender"]:checked');
            activeFilters.gender = [];
            genderCheckboxes.forEach(cb => {
                if (cb.value !== 'all') {
                    activeFilters.gender.push(cb.value);
                }
            });

            // Tamaño
            const sizeCheckboxes = document.querySelectorAll('input[name="size"]:checked');
            activeFilters.size = [];
            sizeCheckboxes.forEach(cb => {
                activeFilters.size.push(cb.value);
            });

            // Marca
            const brandCheckboxes = document.querySelectorAll('input[name="brand"]:checked');
            activeFilters.brand = [];
            brandCheckboxes.forEach(cb => {
                activeFilters.brand.push(cb.value);
            });

            // Tipo de fragancia
            const typeCheckboxes = document.querySelectorAll('input[name="fragranceType"]:checked');
            activeFilters.fragranceType = [];
            typeCheckboxes.forEach(cb => {
                activeFilters.fragranceType.push(cb.value);
            });

            displayProducts();
        }

        // Mostrar productos
        function displayProducts() {
            const container = document.getElementById('products-container');
            
            if (allProducts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="flex flex-col items-center">
                            <div class="bg-gray-100 rounded-full p-4 mb-3">
                                <i class="fas fa-inbox text-gray-400 text-2xl"></i>
                            </div>
                            <p class="text-gray-600 font-medium mb-1">No hay decants disponibles</p>
                            <p class="text-gray-500 text-sm">Vuelve pronto para ver nuestros decants</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Filtrar productos
            let filteredProducts = allProducts.filter(product => {
                // Filtro por género
                if (activeFilters.gender.length > 0) {
                    if (!activeFilters.gender.includes(product.gender)) {
                        return false;
                    }
                }

                // Filtro por tamaño
                if (activeFilters.size.length > 0) {
                    if (!product.decantSize || !activeFilters.size.includes(product.decantSize)) {
                        return false;
                    }
                }

                // Filtro por marca
                if (activeFilters.brand.length > 0) {
                    if (!product.brand || !activeFilters.brand.includes(product.brand)) {
                        return false;
                    }
                }

                // Filtro por tipo de fragancia
                if (activeFilters.fragranceType.length > 0) {
                    if (!product.fragranceType || !activeFilters.fragranceType.includes(product.fragranceType)) {
                        return false;
                    }
                }

                return true;
            });

            // Ordenar productos
            if (currentSort === 'price-asc') {
                filteredProducts.sort((a, b) => (a.price || 0) - (b.price || 0));
            } else if (currentSort === 'price-desc') {
                filteredProducts.sort((a, b) => (b.price || 0) - (a.price || 0));
            } else {
                filteredProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            }

            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="flex flex-col items-center">
                            <div class="bg-gray-100 rounded-full p-4 mb-3">
                                <i class="fas fa-search text-gray-400 text-2xl"></i>
                            </div>
                            <p class="text-gray-600 font-medium mb-1">No se encontraron decants</p>
                            <p class="text-gray-500 text-sm">Intenta con otro filtro</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Generar HTML de productos
            container.innerHTML = filteredProducts.map(product => {
                const imageUrl = product.images && product.images.length > 0 
                    ? product.images[0] 
                    : 'https://via.placeholder.com/300x300?text=No+Image';
                
                const genderBadge = product.gender === 'hombre' 
                    ? '<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">Hombre</span>'
                    : '<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-pink-50 text-pink-700 border border-pink-100">Mujer</span>';
                
                const sizeBadge = product.decantSize 
                    ? `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-100">${product.decantSize}</span>`
                    : '';

                return `
                    <a href="/producto/${product.id}" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg hover:border-gray-200 transition-all duration-300 cursor-pointer flex flex-col h-full block group">
                        <div class="w-full overflow-hidden flex-shrink-0 relative" style="height: 250px; background: linear-gradient(to bottom, #fafafa, #f5f5f5);">
                            <img src="${imageUrl}" alt="${product.name || ''}" class="w-full h-full object-cover object-center group-hover:scale-110 transition-transform duration-500 ease-out" onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
                        </div>
                        <div class="p-4 sm:p-5 flex flex-col flex-grow" style="min-height: 130px;">
                            ${product.brand ? `<p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1.5 line-clamp-1">${product.brand}</p>` : ''}
                            <h3 class="text-sm sm:text-base font-semibold text-gray-900 mb-2 line-clamp-2 leading-snug group-hover:text-gray-700 transition-colors">${product.name || 'Sin nombre'}</h3>
                            <div class="flex items-center gap-1.5 sm:gap-2 mb-3 flex-wrap">
                                ${genderBadge}
                                ${sizeBadge}
                            </div>
                            <div class="flex items-center justify-between mt-auto pt-3 border-t border-gray-100">
                                <span class="text-base sm:text-xl font-bold text-gray-900">$${product.price ? product.price.toFixed(2) : '0.00'}</span>
                            </div>
                        </div>
                    </a>
                `;
            }).join('');
        }

        // Ordenamiento
        document.getElementById('sort-select').addEventListener('change', function() {
            currentSort = this.value;
            displayProducts();
        });

        // Limpiar filtros
        document.getElementById('clear-filters').addEventListener('click', function() {
            document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="gender"]').forEach(cb => cb.checked = false);
            document.querySelector('input[name="gender"][value="all"]').checked = true;
            
            activeFilters = {
                gender: [],
                size: [],
                brand: [],
                fragranceType: []
            };
            
            document.getElementById('sort-select').value = 'relevance';
            currentSort = 'relevance';
            
            displayProducts();
        });

        // Aplicar filtros desde URL
        function applyFiltersFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const tipo = urlParams.get('tipo');
            const genero = urlParams.get('genero');
            const tamaño = urlParams.get('tamaño');
            
            if (genero) {
                const allCheckbox = document.querySelector('input[name="gender"][value="all"]');
                if (allCheckbox) {
                    allCheckbox.checked = false;
                }
                const genderCheckbox = document.querySelector(`input[name="gender"][value="${genero}"]`);
                if (genderCheckbox) {
                    genderCheckbox.checked = true;
                    activeFilters.gender = [genero];
                }
            }
            
            if (tamaño) {
                const sizeCheckbox = document.querySelector(`input[name="size"][value="${tamaño}"]`);
                if (sizeCheckbox) {
                    sizeCheckbox.checked = true;
                    activeFilters.size = [tamaño];
                }
            }
            
            if (tipo) {
                const typeCheckbox = document.querySelector(`input[name="fragranceType"][value="${decodeURIComponent(tipo)}"]`);
                if (typeCheckbox) {
                    typeCheckbox.checked = true;
                    activeFilters.fragranceType = [decodeURIComponent(tipo)];
                }
            }
        }

        // Limpiar y resetear el estado de la página
        function resetPageState() {
            // Scroll inmediato al inicio (sin animación)
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            
            // Asegurar que el body esté en la posición correcta
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
        }

        // Resetear inmediatamente cuando se carga el script
        resetPageState();

        // Cargar productos al iniciar
        function initializePage() {
            resetPageState();
            
            if (typeof db !== 'undefined') {
                setTimeout(() => {
                    loadProducts().then(() => {
                        applyFiltersFromURL();
                        displayProducts();
                    });
                }, 100);
            } else {
                setTimeout(() => {
                    if (typeof db !== 'undefined') {
                        loadProducts().then(() => {
                            applyFiltersFromURL();
                            displayProducts();
                        });
                    } else {
                        setTimeout(initializePage, 500);
                    }
                }, 500);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                resetPageState();
                setTimeout(initializePage, 50);
            });
        } else {
            resetPageState();
            setTimeout(initializePage, 50);
        }
        
        // Resetear cuando la página se carga completamente
        window.addEventListener('load', function() {
            resetPageState();
        });
        
        // Resetear antes de que la página se descargue (cuando navegas)
        window.addEventListener('beforeunload', function() {
            resetPageState();
        });
    </script>
    {% include 'partials/footer.html' %}
</body>
</html>

