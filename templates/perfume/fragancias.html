<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fragancias - ALABAZTRUM</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-white">
    {% include 'partials/navbar.html' %}

    <main class="min-h-screen py-2 bg-gray-50" style="min-height: 100vh; overflow-x: hidden;">
        <div class="container mx-auto px-4">
            <!-- Header con ordenamiento -->
            <div class="mb-4 flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Fragancias</h1>
                </div>
                <!-- Filtros de ordenamiento -->
                <div class="flex items-center gap-2">
                    <!-- Botón Filtros (solo móvil) -->
                    <button id="mobile-filters-toggle" class="lg:hidden flex items-center gap-2 px-3 py-2 bg-gray-900 hover:bg-gray-800 text-white rounded-lg transition font-medium text-sm">
                        <i class="fas fa-filter"></i>
                        <span>Filtros</span>
                    </button>
                    <label class="hidden lg:block text-xs text-gray-600 font-medium">Ordenar por:</label>
                    <div class="relative">
                        <select id="sort-select" class="appearance-none px-4 py-2 pr-8 bg-white border border-gray-300 rounded-lg text-sm text-gray-900 font-medium focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 cursor-pointer hover:border-gray-400 transition-all shadow-sm">
                            <option value="relevance">Relevancia</option>
                            <option value="price-asc">Menor precio</option>
                            <option value="price-desc">Mayor precio</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                            <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de filtros móvil (oculto por defecto) - Pantalla completa -->
            <div id="mobile-filters-overlay" class="lg:hidden hidden fixed inset-0 bg-black bg-opacity-50" onclick="closeMobileFilters()" style="z-index: 1003; width: 100vw; max-width: 100vw;"></div>
            <div id="mobile-filters-panel" class="lg:hidden hidden fixed inset-0 bg-white" style="z-index: 1004; overflow-y: auto; overflow-x: hidden; width: 100vw; max-width: 100vw;">
                <div class="min-h-screen" style="width: 100%; max-width: 100%; padding: 1rem; box-sizing: border-box;">
                    <!-- Header fijo -->
                    <div class="sticky top-0 bg-white border-b border-gray-200 pb-4 mb-4 pt-4 z-10" style="margin-left: -1rem; margin-right: -1rem; padding-left: 1rem; padding-right: 1rem; width: calc(100% + 2rem);">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold text-gray-900">Filtros</h2>
                            <button id="mobile-filters-close" class="text-gray-500 hover:text-gray-700 p-2 flex-shrink-0" onclick="closeMobileFilters()" aria-label="Cerrar filtros">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtro por Género -->
                    <div class="mb-6">
                        <h3 class="text-base font-semibold text-gray-900 mb-3">Género</h3>
                        <div class="space-y-3">
                            <label class="flex items-center cursor-pointer py-2">
                                <input type="checkbox" name="gender-mobile" value="all" class="mr-3 w-5 h-5 rounded border-gray-300 text-gray-900 focus:ring-gray-900" checked>
                                <span class="text-base text-gray-700">Todos</span>
                            </label>
                            <label class="flex items-center cursor-pointer py-2">
                                <input type="checkbox" name="gender-mobile" value="mujer" class="mr-3 w-5 h-5 rounded border-gray-300 text-gray-900 focus:ring-gray-900">
                                <span class="text-base text-gray-700">Mujer</span>
                            </label>
                            <label class="flex items-center cursor-pointer py-2">
                                <input type="checkbox" name="gender-mobile" value="hombre" class="mr-3 w-5 h-5 rounded border-gray-300 text-gray-900 focus:ring-gray-900">
                                <span class="text-base text-gray-700">Hombre</span>
                            </label>
                        </div>
                    </div>

                    <!-- Filtro por Marca -->
                    <div class="mb-6">
                        <h3 class="text-base font-semibold text-gray-900 mb-3">Marca</h3>
                        <div id="brands-filter-mobile" class="space-y-3 max-h-64 overflow-y-auto">
                            <div class="text-gray-400 text-sm">Cargando marcas...</div>
                        </div>
                    </div>

                    <!-- Filtro por Tipo de Fragancia -->
                    <div class="mb-6">
                        <h3 class="text-base font-semibold text-gray-900 mb-3">Tipo de Fragancia</h3>
                        <div id="fragrance-types-filter-mobile" class="space-y-3 max-h-64 overflow-y-auto">
                            <div class="text-gray-400 text-sm">Cargando tipos...</div>
                        </div>
                    </div>

                    <!-- Botones fijos al final -->
                    <div class="sticky bottom-0 bg-white border-t border-gray-200 pt-4 pb-4 mt-6 z-10" style="margin-left: -1rem; margin-right: -1rem; padding-left: 1rem; padding-right: 1rem; width: calc(100% + 2rem);">
                        <button id="clear-filters-mobile" class="w-full px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition font-medium text-base mb-3" style="box-sizing: border-box;">
                            Limpiar Filtros
                        </button>
                        <button onclick="closeMobileFilters()" class="w-full px-4 py-3 bg-gray-900 hover:bg-gray-800 text-white rounded-lg transition font-medium text-base" style="box-sizing: border-box;">
                            Aplicar Filtros
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 items-start">
                <!-- Barra lateral de filtros -->
                <aside class="hidden lg:block w-52 flex-shrink-0">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sticky" style="top: 1rem;">
                        <h2 class="text-sm font-bold text-gray-900 mb-3">Filtros</h2>
                        
                        <!-- Filtro por Género -->
                        <div class="mb-3">
                            <h3 class="text-xs font-semibold text-gray-900 mb-1.5">Género</h3>
                            <div class="space-y-1.5">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="gender" value="all" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900" checked>
                                    <span class="text-sm text-gray-700">Todos</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="gender" value="mujer" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900">
                                    <span class="text-sm text-gray-700">Mujer</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="gender" value="hombre" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900">
                                    <span class="text-sm text-gray-700">Hombre</span>
                                </label>
                            </div>
                        </div>

                        <!-- Filtro por Marca -->
                        <div class="mb-3">
                            <h3 class="text-xs font-semibold text-gray-900 mb-1.5">Marca</h3>
                            <div id="brands-filter" class="space-y-1.5 max-h-36 overflow-y-auto">
                                <div class="text-gray-400 text-sm">Cargando marcas...</div>
                            </div>
                        </div>

                        <!-- Filtro por Tipo de Fragancia -->
                        <div class="mb-3">
                            <h3 class="text-xs font-semibold text-gray-900 mb-1.5">Tipo de Fragancia</h3>
                            <div id="fragrance-types-filter" class="space-y-1.5 max-h-36 overflow-y-auto">
                                <div class="text-gray-400 text-sm">Cargando tipos...</div>
                            </div>
                        </div>

                        <!-- Botón limpiar filtros -->
                        <button id="clear-filters" class="w-full px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition font-medium text-xs mt-2">
                            Limpiar Filtros
                        </button>
                    </div>
                </aside>

                <!-- Contenido principal -->
                <div class="flex-1">
                    <!-- Grid de productos -->
                    <div id="products-container" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-2 sm:gap-3">
                <!-- Los productos se cargarán aquí dinámicamente -->
                <div class="col-span-full text-center py-12">
                    <div class="flex flex-col items-center">
                        <div class="bg-gray-100 rounded-full p-4 mb-3">
                            <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                        </div>
                        <p class="text-gray-600 font-medium">Cargando fragancias...</p>
                    </div>
                </div>
                </div>
                    <!-- Paginación -->
                    <div id="pagination" class="mt-6 flex items-center justify-center gap-2">
                        <!-- Controles de paginación se renderizan dinámicamente -->
                    </div>
            </div>
        </div>
    </main>


    <!-- Scripts Firebase y autenticación -->
    <script src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/navbar-auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/navbar-persistent.js') }}"></script>
    
    <script>
        let allProducts = [];
        let allBrands = [];
        let allFragranceTypes = [];
        let activeFilters = {
            gender: [],
            brand: [],
            fragranceType: []
        };
        let currentSort = 'relevance';

        // Cargar productos
        async function loadProducts() {
            try {
                if (typeof db === 'undefined') {
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            loadProducts().then(resolve);
                        }, 500);
                    });
                }

                const productsSnapshot = await db.collection('products').orderBy('name').get();
                allProducts = [];
                const brandsSet = new Set();
                const typesSet = new Set();
                
                productsSnapshot.forEach((doc) => {
                    const product = doc.data();
                    allProducts.push({
                        id: doc.id,
                        ...product
                    });
                    
                    if (product.brand) brandsSet.add(product.brand);
                    if (product.fragranceType) typesSet.add(product.fragranceType);
                });

                allBrands = Array.from(brandsSet).sort();
                allFragranceTypes = Array.from(typesSet).sort();

                loadFilters();
                
                // Aplicar filtros desde URL después de cargar los filtros
                // Usar setTimeout para asegurar que los checkboxes estén en el DOM
                setTimeout(() => {
                    applyFiltersFromURL();
                    displayProducts();
                }, 50);
            } catch (error) {
                const unauth = (typeof auth !== 'undefined') ? !isAuthenticated() : true;
                const permErr = error && (error.code === 'permission-denied' || (String(error).toLowerCase().includes('insufficient permissions')));
                const container = document.getElementById('products-container');
                if (!container) return;
                if (unauth && permErr) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <p class="text-gray-600 mb-4">Necesitas iniciar sesión para ver productos.</p>
                            <a href="/login" class="inline-block px-4 py-2 bg-gray-900 text-white rounded-md">Iniciar sesión</a>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="flex flex-col items-center">
                                <div class="bg-red-100 rounded-full p-4 mb-3">
                                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                                </div>
                                <p class="text-red-600 font-medium mb-1">Error al cargar productos</p>
                                <p class="text-gray-500 text-sm">Por favor, intenta recargar la página</p>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // Cargar filtros
        function loadFilters() {
            // Cargar marcas
            const brandsContainer = document.getElementById('brands-filter');
            if (allBrands.length > 0) {
                brandsContainer.innerHTML = allBrands.map(brand => `
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" name="brand" value="${brand}" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900 filter-checkbox">
                        <span class="text-sm text-gray-700">${brand}</span>
                    </label>
                `).join('');
            } else {
                brandsContainer.innerHTML = '<div class="text-gray-400 text-sm">No hay marcas disponibles</div>';
            }

            // Cargar tipos de fragancia
            const typesContainer = document.getElementById('fragrance-types-filter');
            if (allFragranceTypes.length > 0) {
                typesContainer.innerHTML = allFragranceTypes.map(type => `
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" name="fragranceType" value="${type}" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900 filter-checkbox">
                        <span class="text-sm text-gray-700">${type}</span>
                    </label>
                `).join('');
            } else {
                typesContainer.innerHTML = '<div class="text-gray-400 text-sm">No hay tipos disponibles</div>';
            }

            // Cargar marcas (móvil)
            const brandsContainerMobile = document.getElementById('brands-filter-mobile');
            if (brandsContainerMobile) {
                if (allBrands.length > 0) {
                    brandsContainerMobile.innerHTML = allBrands.map(brand => `
                        <label class="flex items-center cursor-pointer py-2">
                            <input type="checkbox" name="brand-mobile" value="${brand}" class="mr-3 w-5 h-5 rounded border-gray-300 text-gray-900 focus:ring-gray-900 filter-checkbox-mobile">
                            <span class="text-base text-gray-700">${brand}</span>
                        </label>
                    `).join('');
                } else {
                    brandsContainerMobile.innerHTML = '<div class="text-gray-400 text-base">No hay marcas disponibles</div>';
                }
            }

            // Cargar tipos de fragancia (móvil)
            const typesContainerMobile = document.getElementById('fragrance-types-filter-mobile');
            if (typesContainerMobile) {
                if (allFragranceTypes.length > 0) {
                    typesContainerMobile.innerHTML = allFragranceTypes.map(type => `
                        <label class="flex items-center cursor-pointer py-2">
                            <input type="checkbox" name="fragranceType-mobile" value="${type}" class="mr-3 w-5 h-5 rounded border-gray-300 text-gray-900 focus:ring-gray-900 filter-checkbox-mobile">
                            <span class="text-base text-gray-700">${type}</span>
                        </label>
                    `).join('');
                } else {
                    typesContainerMobile.innerHTML = '<div class="text-gray-400 text-base">No hay tipos disponibles</div>';
                }
            }

            // Agregar event listeners a los checkboxes
            document.querySelectorAll('.filter-checkbox, .filter-checkbox-mobile').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    syncCheckboxes(this);
                    updateFilters();
                });
            });

            // Event listener para los checkboxes de género (desktop y móvil)
            document.querySelectorAll('input[name="gender"], input[name="gender-mobile"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const isMobile = this.name === 'gender-mobile';
                    const otherName = isMobile ? 'gender' : 'gender-mobile';
                    
                    if (this.value === 'all' && this.checked) {
                        // Si se selecciona "Todos", desmarcar los demás
                        document.querySelectorAll(`input[name="${this.name}"]:not([value="all"])`).forEach(cb => cb.checked = false);
                        document.querySelectorAll(`input[name="${otherName}"]:not([value="all"])`).forEach(cb => cb.checked = false);
                        const allCheckbox = document.querySelector(`input[name="${otherName}"][value="all"]`);
                        if (allCheckbox) allCheckbox.checked = true;
                    } else if (this.value !== 'all' && this.checked) {
                        // Si se selecciona un género específico, desmarcar "Todos"
                        document.querySelector(`input[name="${this.name}"][value="all"]`).checked = false;
                        const otherAllCheckbox = document.querySelector(`input[name="${otherName}"][value="all"]`);
                        if (otherAllCheckbox) otherAllCheckbox.checked = false;
                        // Sincronizar el checkbox del otro panel
                        const otherCheckbox = document.querySelector(`input[name="${otherName}"][value="${this.value}"]`);
                        if (otherCheckbox) otherCheckbox.checked = true;
                    }
                    updateFilters();
                });
            });
        }

        // Sincronizar checkboxes entre desktop y móvil
        function syncCheckboxes(checkbox) {
            const name = checkbox.name;
            const value = checkbox.value;
            const isChecked = checkbox.checked;
            
            // Si es un checkbox móvil, sincronizar con desktop
            if (name.includes('-mobile')) {
                const desktopName = name.replace('-mobile', '');
                const desktopCheckbox = document.querySelector(`input[name="${desktopName}"][value="${value}"]`);
                if (desktopCheckbox) {
                    desktopCheckbox.checked = isChecked;
                }
            } else {
                // Si es un checkbox desktop, sincronizar con móvil
                const mobileName = name + '-mobile';
                const mobileCheckbox = document.querySelector(`input[name="${mobileName}"][value="${value}"]`);
                if (mobileCheckbox) {
                    mobileCheckbox.checked = isChecked;
                }
            }
        }

        // Actualizar filtros activos
        function updateFilters() {
            // Género (considerar tanto desktop como móvil)
            const genderCheckboxes = document.querySelectorAll('input[name="gender"]:checked, input[name="gender-mobile"]:checked');
            activeFilters.gender = [];
            genderCheckboxes.forEach(cb => {
                if (cb.value !== 'all') {
                    activeFilters.gender.push(cb.value);
                }
            });

            // Marca (considerar tanto desktop como móvil)
            const brandCheckboxes = document.querySelectorAll('input[name="brand"]:checked, input[name="brand-mobile"]:checked');
            activeFilters.brand = [];
            brandCheckboxes.forEach(cb => {
                activeFilters.brand.push(cb.value);
            });

            // Tipo de fragancia (considerar tanto desktop como móvil)
            const typeCheckboxes = document.querySelectorAll('input[name="fragranceType"]:checked, input[name="fragranceType-mobile"]:checked');
            activeFilters.fragranceType = [];
            typeCheckboxes.forEach(cb => {
                activeFilters.fragranceType.push(cb.value);
            });

            displayProducts();
        }

        // Estado de paginación
        let currentPage = 1;
        const pageSize = 20;

        function renderPagination(totalItems) {
            const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
            const pagination = document.getElementById('pagination');
            if (!pagination) return;
            if (totalItems === 0) {
                pagination.innerHTML = '';
                return;
            }
            const prevDisabled = currentPage <= 1 ? 'opacity-50 cursor-not-allowed' : '';
            const nextDisabled = currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : '';
            pagination.innerHTML = `
                <button id="prev-page" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded ${prevDisabled}">Anterior</button>
                <span class="text-sm text-gray-600">Página ${currentPage} de ${totalPages}</span>
                <button id="next-page" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded ${nextDisabled}">Siguiente</button>
            `;
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayProducts();
                    }
                });
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    const maxPage = Math.max(1, Math.ceil(totalItems / pageSize));
                    if (currentPage < maxPage) {
                        currentPage++;
                        displayProducts();
                    }
                });
            }
        }

        // Mostrar productos
        function displayProducts() {
            const container = document.getElementById('products-container');
            
            if (allProducts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="flex flex-col items-center">
                            <div class="bg-gray-100 rounded-full p-4 mb-3">
                                <i class="fas fa-inbox text-gray-400 text-2xl"></i>
                            </div>
                            <p class="text-gray-600 font-medium mb-1">No hay productos disponibles</p>
                            <p class="text-gray-500 text-sm">Vuelve pronto para ver nuestras fragancias</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Filtrar productos
            console.log('Filtrando productos. Total:', allProducts.length, 'Filtros activos:', activeFilters);
            let filteredProducts = allProducts.filter(product => {
                // Filtro por género
                if (activeFilters.gender.length > 0) {
                    if (!activeFilters.gender.includes(product.gender)) {
                        return false;
                    }
                }

                // Filtro por marca
                if (activeFilters.brand.length > 0) {
                    if (!product.brand || !activeFilters.brand.includes(product.brand)) {
                        return false;
                    }
                }

                // Filtro por tipo de fragancia
                if (activeFilters.fragranceType.length > 0) {
                    if (!product.fragranceType || !activeFilters.fragranceType.includes(product.fragranceType)) {
                        return false;
                    }
                }

                return true;
            });
            console.log('Productos filtrados:', filteredProducts.length);

            // Ordenar productos
            if (currentSort === 'price-asc') {
                filteredProducts.sort((a, b) => (a.price || 0) - (b.price || 0));
            } else if (currentSort === 'price-desc') {
                filteredProducts.sort((a, b) => (b.price || 0) - (a.price || 0));
            } else {
                // Relevancia (orden por nombre por defecto)
                filteredProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            }

            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="flex flex-col items-center">
                            <div class="bg-gray-100 rounded-full p-4 mb-3">
                                <i class="fas fa-search text-gray-400 text-2xl"></i>
                            </div>
                            <p class="text-gray-600 font-medium mb-1">No se encontraron productos</p>
                            <p class="text-gray-500 text-sm">Intenta con otro filtro</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Paginación
            const startIndex = (currentPage - 1) * pageSize;
            const pageItems = filteredProducts.slice(startIndex, startIndex + pageSize);

            // Generar HTML de productos
            container.innerHTML = pageItems.map(product => {
                const imageUrl = product.images && product.images.length > 0 
                    ? product.images[0] 
                    : 'https://via.placeholder.com/300x300?text=No+Image';
                
                const genderBadge = product.gender === 'hombre' 
                    ? '<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">Hombre</span>'
                    : '<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-pink-50 text-pink-700 border border-pink-100">Mujer</span>';
                
                const decantBadge = product.isDecant 
                    ? `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-100">Decant ${product.decantSize || ''}</span>`
                    : '';

                return `
                    <a href="/producto/${product.id}" class="relative bg-white rounded-xl border border-gray-200 shadow-sm ring-1 ring-gray-100 hover:ring-gray-300 overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 cursor-pointer flex flex-col h-full block group">
                        <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-gray-900 via-gray-700 to-gray-900"></div>
                        <div class="w-full overflow-hidden flex-shrink-0 relative" style="height: 250px; background: linear-gradient(to bottom, #fafafa, #f5f5f5);">
                            <img src="${imageUrl}" alt="${product.name || ''}" class="w-full h-full object-cover object-center group-hover:scale-110 transition-transform duration-500 ease-out" onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
                        </div>
                        <div class="p-5 flex flex-col flex-grow bg-white" style="min-height: 140px;">
                            ${product.brand ? `<p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1.5 line-clamp-1">${product.brand}</p>` : ''}
                            <h3 class="text-base font-semibold text-gray-900 mb-2 line-clamp-2 leading-snug tracking-tight group-hover:text-gray-700 transition-colors">${product.name || 'Sin nombre'}</h3>
                            <div class="flex items-center gap-2 mb-4 flex-wrap">
                                ${genderBadge}
                                ${decantBadge}
                            </div>
                            <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-100">
                                <span class="text-xl font-bold text-gray-900">$${product.price ? product.price.toFixed(2) : '0.00'}</span>
                            </div>
                        </div>
                    </a>
                `;
            }).join('');

            // Renderizar paginación
            renderPagination(filteredProducts.length);
        }

        // Ordenamiento
        document.getElementById('sort-select').addEventListener('change', function() {
            currentSort = this.value;
            currentPage = 1;
            displayProducts();
        });

        // Función para abrir panel de filtros móvil
        function openMobileFilters() {
            const panel = document.getElementById('mobile-filters-panel');
            const overlay = document.getElementById('mobile-filters-overlay');
            panel.classList.remove('hidden');
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevenir scroll del body
        }

        // Función para cerrar panel de filtros móvil
        function closeMobileFilters() {
            const panel = document.getElementById('mobile-filters-panel');
            const overlay = document.getElementById('mobile-filters-overlay');
            panel.classList.add('hidden');
            overlay.classList.add('hidden');
            document.body.style.overflow = ''; // Restaurar scroll del body
        }

        // Toggle del panel de filtros móvil
        document.getElementById('mobile-filters-toggle').addEventListener('click', openMobileFilters);

        // Cerrar panel de filtros móvil
        document.getElementById('mobile-filters-close').addEventListener('click', closeMobileFilters);

        // Hacer funciones globales
        window.openMobileFilters = openMobileFilters;
        window.closeMobileFilters = closeMobileFilters;

        // Limpiar filtros (desktop)
        document.getElementById('clear-filters').addEventListener('click', function() {
            // Desmarcar todos los checkboxes
            document.querySelectorAll('.filter-checkbox, .filter-checkbox-mobile').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="gender"], input[name="gender-mobile"]').forEach(cb => cb.checked = false);
            // Marcar "Todos" en género
            const allGenderDesktop = document.querySelector('input[name="gender"][value="all"]');
            const allGenderMobile = document.querySelector('input[name="gender-mobile"][value="all"]');
            if (allGenderDesktop) allGenderDesktop.checked = true;
            if (allGenderMobile) allGenderMobile.checked = true;
            
            // Limpiar filtros activos
            activeFilters = {
                gender: [],
                brand: [],
                fragranceType: []
            };
            
            // Resetear ordenamiento
            document.getElementById('sort-select').value = 'relevance';
            currentSort = 'relevance';
            currentPage = 1;
            
            displayProducts();
        });

        // Limpiar filtros (móvil)
        const clearFiltersMobile = document.getElementById('clear-filters-mobile');
        if (clearFiltersMobile) {
            clearFiltersMobile.addEventListener('click', function() {
                // Desmarcar todos los checkboxes
                document.querySelectorAll('.filter-checkbox, .filter-checkbox-mobile').forEach(cb => cb.checked = false);
                document.querySelectorAll('input[name="gender"], input[name="gender-mobile"]').forEach(cb => cb.checked = false);
                // Marcar "Todos" en género
                const allGenderDesktop = document.querySelector('input[name="gender"][value="all"]');
                const allGenderMobile = document.querySelector('input[name="gender-mobile"][value="all"]');
                if (allGenderDesktop) allGenderDesktop.checked = true;
                if (allGenderMobile) allGenderMobile.checked = true;
                
                // Limpiar filtros activos
                activeFilters = {
                    gender: [],
                    brand: [],
                    fragranceType: []
                };
                
                // Resetear ordenamiento
                document.getElementById('sort-select').value = 'relevance';
                currentSort = 'relevance';
                currentPage = 1;
                
                displayProducts();
            });
        }

        // Aplicar filtros desde URL
        function applyFiltersFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const tipo = urlParams.get('tipo');
            const genero = urlParams.get('genero');
            const marca = urlParams.get('marca');
            
            if (genero) {
                // Desmarcar "Todos" y marcar el género correspondiente
                const allCheckbox = document.querySelector('input[name="gender"][value="all"]');
                if (allCheckbox) {
                    allCheckbox.checked = false;
                }
                const genderCheckbox = document.querySelector(`input[name="gender"][value="${genero}"]`);
                if (genderCheckbox) {
                    genderCheckbox.checked = true;
                    activeFilters.gender = [genero];
                }
                // Sincronizar con móvil
                const allCheckboxMobile = document.querySelector('input[name="gender-mobile"][value="all"]');
                if (allCheckboxMobile) {
                    allCheckboxMobile.checked = false;
                }
                const genderCheckboxMobile = document.querySelector(`input[name="gender-mobile"][value="${genero}"]`);
                if (genderCheckboxMobile) {
                    genderCheckboxMobile.checked = true;
                }
            }
            
            if (tipo) {
                // Marcar el tipo de fragancia correspondiente
                const decodedTipo = decodeURIComponent(tipo);
                const typeCheckbox = document.querySelector(`input[name="fragranceType"][value="${decodedTipo}"]`);
                if (typeCheckbox) {
                    typeCheckbox.checked = true;
                    activeFilters.fragranceType = [decodedTipo];
                }
                // Sincronizar con móvil
                const typeCheckboxMobile = document.querySelector(`input[name="fragranceType-mobile"][value="${decodedTipo}"]`);
                if (typeCheckboxMobile) {
                    typeCheckboxMobile.checked = true;
                }
            }
            
            if (marca) {
                // Aplicar el filtro de marca directamente, independientemente de si el checkbox existe
                const decodedMarca = decodeURIComponent(marca);
                activeFilters.brand = [decodedMarca];
                console.log('Filtro de marca aplicado:', decodedMarca, 'Filtros activos:', activeFilters);
                
                // Intentar encontrar y marcar el checkbox de marca (puede que aún no esté cargado)
                const brandCheckbox = document.querySelector(`input[name="brand"][value="${decodedMarca}"]`);
                if (brandCheckbox) {
                    brandCheckbox.checked = true;
                }
                // Sincronizar con móvil
                const brandCheckboxMobile = document.querySelector(`input[name="brand-mobile"][value="${decodedMarca}"]`);
                if (brandCheckboxMobile) {
                    brandCheckboxMobile.checked = true;
                }
                
                // Si no se encontró el checkbox, intentar de nuevo después de un pequeño delay
                // (por si los filtros aún se están cargando)
                if (!brandCheckbox && !brandCheckboxMobile) {
                    setTimeout(() => {
                        const retryBrandCheckbox = document.querySelector(`input[name="brand"][value="${decodedMarca}"]`);
                        const retryBrandCheckboxMobile = document.querySelector(`input[name="brand-mobile"][value="${decodedMarca}"]`);
                        if (retryBrandCheckbox) {
                            retryBrandCheckbox.checked = true;
                        }
                        if (retryBrandCheckboxMobile) {
                            retryBrandCheckboxMobile.checked = true;
                        }
                    }, 200);
                }
            }
        }

        // Limpiar y resetear el estado de la página
        function resetPageState() {
            // Scroll inmediato al inicio (sin animación)
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            
            // Asegurar que el body esté en la posición correcta
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
        }

        // Resetear inmediatamente cuando se carga el script
        resetPageState();

        // Cargar productos al iniciar
        function initializePage() {
            resetPageState();
            
            if (typeof db !== 'undefined') {
                setTimeout(() => {
                    loadProducts();
                }, 100);
            } else {
                setTimeout(() => {
                    if (typeof db !== 'undefined') {
                        loadProducts();
                    } else {
                        setTimeout(initializePage, 500);
                    }
                }, 500);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                resetPageState();
                setTimeout(initializePage, 50);
            });
        } else {
            resetPageState();
            setTimeout(initializePage, 50);
        }
        
        // Resetear cuando la página se carga completamente
        window.addEventListener('load', function() {
            resetPageState();
        });
        
        // Resetear antes de que la página se descargue (cuando navegas)
        window.addEventListener('beforeunload', function() {
            resetPageState();
        });
    </script>
    {% include 'partials/footer.html' %}
</body>
</html>
