<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALABAZTRUM - Perfumes de Navidad</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body class="bg-white">
    {% include 'partials/navbar.html' %}

    <main class="w-full bg-white">

        <section class="py-20 bg-gray-50">
            <div class="container mx-auto px-4">
                

                <div class="flex gap-6">
                    <aside class="w-64 hidden lg:block">
                        <div class="bg-white rounded-lg border border-gray-200 p-4">
                            <div class="mb-3">
                                <h3 class="text-xs font-semibold text-gray-900 mb-1.5">Género</h3>
                                <div class="space-y-1.5">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="gender" value="all" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900">
                                        <span class="text-sm text-gray-700">Todos</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="gender" value="hombre" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900">
                                        <span class="text-sm text-gray-700">Masculinas</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="gender" value="mujer" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900">
                                        <span class="text-sm text-gray-700">Femeninas</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <h3 class="text-xs font-semibold text-gray-900 mb-1.5">Marcas</h3>
                                <div id="brands-filter" class="space-y-1.5 max-h-36 overflow-y-auto">
                                    <div class="text-gray-400 text-sm">Cargando marcas...</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <h3 class="text-xs font-semibold text-gray-900 mb-1.5">Tipo de Fragancia</h3>
                                <div id="types-filter" class="space-y-1.5 max-h-36 overflow-y-auto">
                                    <div class="text-gray-400 text-sm">Cargando tipos...</div>
                                </div>
                            </div>
                            <button id="clear-filters" class="w-full px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition font-medium text-xs mt-2">
                                Limpiar Filtros
                            </button>
                        </div>
                    </aside>
                    <div class="flex-1">
                        <div id="products-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                            <div class="col-span-full text-center py-12">
                                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
                                <p class="text-gray-600 mt-4">Cargando productos...</p>
                            </div>
                        </div>
                        <div id="pagination" class="mt-8 flex items-center justify-center gap-3"></div>
                    </div>
                </div>
            </div>
        </section>



        {% include 'partials/footer.html' %}

        <!-- Botón flotante de WhatsApp -->
        <a href="https://wa.me/9191936256" target="_blank" rel="noopener" class="whatsapp-float"
            aria-label="Contactar por WhatsApp">
            <i class="fab fa-whatsapp"></i>
        </a>

        <!-- Scripts Firebase y autenticación -->
        <script src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
        <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
        <script src="{{ url_for('static', filename='js/auth-manager.js') }}"></script>
        <script src="{{ url_for('static', filename='js/navbar-auth.js') }}"></script>
        <script src="{{ url_for('static', filename='js/navbar-persistent.js') }}"></script>

        <script>
            let allProducts = [];
            let allBrands = [];
            let allTypes = [];
            let currentPage = 1;
            const pageSize = 20;
            let activeFilters = { gender: [], brand: [], type: [] };

            function renderPagination(totalItems) {
                const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
                const pagination = document.getElementById('pagination');
                if (!pagination) return;
                if (totalItems === 0) {
                    pagination.innerHTML = '';
                    return;
                }
                const prevDisabled = currentPage <= 1 ? 'opacity-50 cursor-not-allowed' : '';
                const nextDisabled = currentPage >= totalPages ? 'opacity-50 cursor-not-allowed' : '';
                pagination.innerHTML = `
                    <button id="prev-page" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded ${prevDisabled}">Anterior</button>
                    <span class="text-sm text-gray-600">Página ${currentPage} de ${totalPages}</span>
                    <button id="next-page" class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded ${nextDisabled}">Siguiente</button>
                `;
                const prevBtn = document.getElementById('prev-page');
                const nextBtn = document.getElementById('next-page');
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        if (currentPage > 1) {
                            currentPage--;
                            displayProducts();
                        }
                    });
                }
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        const maxPage = Math.max(1, Math.ceil(totalItems / pageSize));
                        if (currentPage < maxPage) {
                            currentPage++;
                            displayProducts();
                        }
                    });
                }
            }

            function displayProducts() {
                const container = document.getElementById('products-container');
                if (!container) return;

                let filtered = allProducts.slice();
                if (activeFilters.gender.length === 1) {
                    const g = activeFilters.gender[0];
                    if (g !== 'all') filtered = filtered.filter(p => (p.gender || '').toLowerCase() === g);
                }
                if (activeFilters.brand.length > 0) {
                    const set = new Set(activeFilters.brand.map(b => b.toLowerCase()));
                    filtered = filtered.filter(p => set.has((p.brand || '').toLowerCase()));
                }
                if (activeFilters.type.length > 0) {
                    const setT = new Set(activeFilters.type.map(t => t.toLowerCase()));
                    filtered = filtered.filter(p => setT.has((p.fragranceType || '').toLowerCase()));
                }

                if (!filtered || filtered.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <p class="text-gray-600">No hay productos con esos filtros</p>
                        </div>
                    `;
                    document.getElementById('pagination').innerHTML = '';
                    return;
                }

                const startIndex = (currentPage - 1) * pageSize;
                const pageItems = filtered.slice(startIndex, startIndex + pageSize);

                container.innerHTML = pageItems.map(product => {
                    const imageUrl = product.images && product.images.length > 0 
                        ? product.images[0] 
                        : 'https://via.placeholder.com/300x300?text=Sin+Imagen';

                    const genderBadge = product.gender === 'hombre' 
                        ? '<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">Hombre</span>'
                        : '<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-pink-50 text-pink-700 border border-pink-100">Mujer</span>';

                    return `
                        <a href="/producto/${product.id}" class="relative bg-white rounded-xl overflow-hidden border border-gray-200 shadow-sm ring-1 ring-gray-100 hover:ring-gray-300 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex flex-col h-full block group">
                            <div class="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-gray-900 via-gray-700 to-gray-900"></div>
                            <div class="w-full overflow-hidden flex-shrink-0 relative" style="height: 300px; background: linear-gradient(to bottom, #fafafa, #f5f5f5);">
                                <img 
                                    src="${imageUrl}" 
                                    alt="${product.name || 'Producto'}"
                                    class="w-full h-full object-cover object-center group-hover:scale-110 transition-transform duration-500 ease-out"
                                    onerror="this.src='https://via.placeholder.com/300x300?text=Sin+Imagen'"
                                >
                            </div>
                            <div class="p-5 flex flex-col flex-grow bg-white" style="min-height: 160px;">
                                <p class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2 line-clamp-1">${product.brand || 'Sin marca'}</p>
                                <h3 class="text-base font-semibold text-gray-900 mb-2 line-clamp-2 leading-snug tracking-tight group-hover:text-gray-700 transition-colors flex-1">
                                    ${product.name || 'Sin nombre'}
                                </h3>
                                <div class="flex items-center justify-between mt-auto pt-4 border-t border-gray-100">
                                    <span class="text-xl font-bold text-gray-900">$${product.price ? parseFloat(product.price).toFixed(2) : '0.00'}</span>
                                    <span class="text-xs px-2.5 py-1 rounded-full font-medium">${genderBadge}</span>
                                </div>
                            </div>
                        </a>
                    `;
                }).join('');

                renderPagination(filtered.length);
            }

            async function loadAllProducts() {
                try {
                    if (typeof db === 'undefined') {
                        setTimeout(loadAllProducts, 500);
                        return;
                    }
                    let snapshot;
                    try {
                        snapshot = await db.collection('products')
                            .where('isDecant', '==', false)
                            .orderBy('name')
                            .get();
                    } catch (e) {
                        snapshot = await db.collection('products')
                            .orderBy('name')
                            .get();
                    }
                    allProducts = [];
                    const brandSet = new Set();
                    const typeSet = new Set();
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (!data || data.isDecant === true) return;
                        allProducts.push({ id: doc.id, ...data });
                        if (data.brand) brandSet.add(data.brand);
                        if (data.fragranceType) typeSet.add(data.fragranceType);
                    });
                    allBrands = Array.from(brandSet).sort();
                    allTypes = Array.from(typeSet).sort();
                    currentPage = 1;
                    loadFilters();
                    displayProducts();
                } catch (error) {
                    const container = document.getElementById('products-container');
                    if (container) {
                        container.innerHTML = `
                            <div class="col-span-full text-center py-12">
                                <p class="text-gray-600">Error al cargar productos. Por favor, intenta más tarde.</p>
                            </div>
                        `;
                    }
                    document.getElementById('pagination').innerHTML = '';
                }
            }

            function loadFilters() {
                const brandsEl = document.getElementById('brands-filter');
                const typesEl = document.getElementById('types-filter');
                if (brandsEl) {
                    brandsEl.innerHTML = allBrands.map(brand => `
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" name="brand" value="${brand}" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900">
                            <span class="text-sm text-gray-700">${brand}</span>
                        </label>
                    `).join('');
                }
                if (typesEl) {
                    typesEl.innerHTML = allTypes.map(type => `
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" name="type" value="${type}" class="mr-2 rounded border-gray-300 text-gray-900 focus:ring-gray-900">
                            <span class="text-sm text-gray-700">${type}</span>
                        </label>
                    `).join('');
                }
                const genderAll = document.querySelector('input[name="gender"][value="all"]');
                if (genderAll) genderAll.checked = true;
                bindFilterEvents();
            }

            function bindFilterEvents() {
                document.querySelectorAll('input[name="gender"]').forEach(el => {
                    el.addEventListener('change', function() {
                        activeFilters.gender = [this.value];
                        currentPage = 1;
                        displayProducts();
                    });
                });
                document.querySelectorAll('input[name="brand"]').forEach(el => {
                    el.addEventListener('change', function() {
                        const vals = Array.from(document.querySelectorAll('input[name="brand"]:checked')).map(i => i.value);
                        activeFilters.brand = vals;
                        currentPage = 1;
                        displayProducts();
                    });
                });
                document.querySelectorAll('input[name="type"]').forEach(el => {
                    el.addEventListener('change', function() {
                        const vals = Array.from(document.querySelectorAll('input[name="type"]:checked')).map(i => i.value);
                        activeFilters.type = vals;
                        currentPage = 1;
                        displayProducts();
                    });
                });
                const clearBtn = document.getElementById('clear-filters');
                if (clearBtn) {
                    clearBtn.addEventListener('click', function() {
                        document.querySelectorAll('input[name="brand"], input[name="type"]').forEach(i => i.checked = false);
                        const genderAll = document.querySelector('input[name="gender"][value="all"]');
                        if (genderAll) {
                            document.querySelectorAll('input[name="gender"]').forEach(i => i.checked = false);
                            genderAll.checked = true;
                        }
                        activeFilters = { gender: [], brand: [], type: [] };
                        currentPage = 1;
                        displayProducts();
                    });
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(loadAllProducts, 300);
            });
        </script>
