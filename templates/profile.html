<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - ALABAZTRUM</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-white profile-page">
    {% include 'partials/navbar.html' %}

    <!-- Área principal -->
    <main class="min-h-screen bg-gray-50 py-6 md:py-12">
        <div class="container mx-auto px-4">
            <div class="max-w-6xl mx-auto">
                <!-- Contenido del perfil -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="text-center mb-6">
                        <div class="w-24 h-24 bg-gray-300 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <i class="far fa-user text-4xl text-gray-600"></i>
                        </div>
                        <h2 id="profile-name" class="text-2xl font-bold text-gray-800 mb-2">Cargando...</h2>
                        <p id="profile-email" class="text-gray-600 mb-6">Cargando...</p>
                    </div>
                    
                    <div class="border-t pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">Información de la cuenta</h3>
                            <button id="edit-profile-btn" onclick="toggleEditMode()" class="px-4 py-2 bg-gray-900 hover:bg-gray-800 text-white text-sm font-medium rounded-lg transition">
                                <i class="fas fa-edit mr-2"></i>Editar
                            </button>
                        </div>
                        
                        <form id="profile-edit-form" class="space-y-4 hidden">
                            <div>
                                <label for="edit-fullname" class="block text-sm font-medium text-gray-700 mb-1">
                                    Nombre completo <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="edit-fullname" 
                                    name="fullname"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900"
                                >
                            </div>
                            <div>
                                <label for="edit-email" class="block text-sm font-medium text-gray-700 mb-1">
                                    Correo electrónico <span class="text-red-500">*</span>
                                </label>
                                <input 
                                    type="email" 
                                    id="edit-email" 
                                    name="email"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900"
                                >
                            </div>
                            <div>
                                <label for="edit-phone" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                                <input 
                                    type="tel" 
                                    id="edit-phone" 
                                    name="phone"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900"
                                    placeholder="+52 123 456 7890"
                                >
                            </div>
                            <div>
                                <label for="edit-address" class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                                <textarea 
                                    id="edit-address" 
                                    name="address"
                                    rows="3"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 resize-none"
                                    placeholder="Tu dirección completa"
                                ></textarea>
                            </div>
                            
                            <!-- Mensaje de éxito/error -->
                            <div id="edit-profile-message" class="hidden p-4 rounded-lg"></div>
                            
                            <!-- Botones -->
                            <div class="flex items-center justify-end space-x-4 pt-4 border-t border-gray-200">
                                <button 
                                    type="button" 
                                    onclick="toggleEditMode()"
                                    class="px-6 py-2 text-gray-700 hover:text-gray-900 transition font-medium"
                                >
                                    Cancelar
                                </button>
                                <button 
                                    type="submit" 
                                    class="bg-gray-900 hover:bg-gray-800 text-white font-semibold py-2 px-6 rounded-lg transition"
                                >
                                    Guardar Cambios
                                </button>
                            </div>
                        </form>
                        
                        <div id="profile-info-view" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre completo</label>
                                <p id="profile-fullname" class="text-gray-900">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Correo electrónico</label>
                                <p id="profile-email-detail" class="text-gray-900">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                                <p id="profile-phone" class="text-gray-900">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                                <p id="profile-address" class="text-gray-900">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de registro</label>
                                <p id="profile-created" class="text-gray-900">-</p>
                            </div>
                        </div>
                    </div>
                </div>

        </div>
    </main>

    <!-- Scripts Firebase y autenticación -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/navbar-auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/navbar-persistent.js') }}"></script>
    
    <script>
        if (typeof currentUser === 'undefined') {
            var currentUser = null;
        }
        let userData = {};


        // Cargar información del perfil
        function loadUserInfo() {
            try {
                // Verificar que Firebase esté disponible
                if (typeof firebase === 'undefined') {
                    console.log('Esperando Firebase...');
                    setTimeout(loadUserInfo, 500);
                    return;
                }

                const auth = firebase.auth();
                
                if (!auth) {
                    console.log('Esperando auth...');
                    setTimeout(loadUserInfo, 500);
                    return;
                }
                
                // Obtener usuario actual directamente primero
                const currentUserAuth = auth.currentUser;
                if (currentUserAuth) {
                    updateUserInfo(currentUserAuth);
                }
                
                // También escuchar cambios de autenticación
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        updateUserInfo(user);
                    } else {
                        // Usuario no autenticado, redirigir al login
                        window.location.href = '/login';
                    }
                });
            } catch (error) {
                console.error('Error en loadUserInfo:', error);
            }
        }

        // Función para actualizar la información del usuario
        async function updateUserInfo(user) {
            try {
                currentUser = user;
                
                // Verificar que db esté disponible
                if (typeof db === 'undefined') {
                    // Intentar obtener db de firebase
                    if (typeof firebase !== 'undefined' && firebase.firestore) {
                        db = firebase.firestore();
                    } else {
                        setTimeout(() => updateUserInfo(user), 500);
                        return;
                    }
                }
                
                // Mostrar información básica inmediatamente
                const profileName = document.getElementById('profile-name');
                const profileEmail = document.getElementById('profile-email');
                const profileEmailDetail = document.getElementById('profile-email-detail');
                const profileFullname = document.getElementById('profile-fullname');
                const profilePhone = document.getElementById('profile-phone');
                const profileAddress = document.getElementById('profile-address');
                const profileCreated = document.getElementById('profile-created');
                
                if (profileName) {
                    profileName.textContent = user.displayName || user.email?.split('@')[0] || 'Usuario';
                }
                if (profileEmail) {
                    profileEmail.textContent = user.email || 'No disponible';
                }
                if (profileEmailDetail) {
                    profileEmailDetail.textContent = user.email || 'No disponible';
                }
                if (profileFullname) {
                    profileFullname.textContent = user.displayName || user.email?.split('@')[0] || '-';
                }
                if (profilePhone) {
                    profilePhone.textContent = '-';
                }
                if (profileAddress) {
                    profileAddress.textContent = '-';
                }
                
                // Intentar obtener información adicional de Firestore
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        userData = userDoc.data();
                        if (userData.fullName && profileFullname) {
                            profileFullname.textContent = userData.fullName;
                        }
                        if (userData.fullName && profileName) {
                            profileName.textContent = userData.fullName;
                        }
                        if (userData.phone && profilePhone) {
                            profilePhone.textContent = userData.phone;
                        }
                        if (userData.address && profileAddress) {
                            profileAddress.textContent = userData.address;
                        }
                        if (userData.createdAt && profileCreated) {
                            const date = userData.createdAt.toDate();
                            profileCreated.textContent = date.toLocaleDateString('es-ES');
                        } else if (profileCreated) {
                            profileCreated.textContent = 'No disponible';
                        }
                    } else {
                        // Si no existe el documento, usar la fecha de creación de auth
                        if (profileCreated) {
                            if (user.metadata && user.metadata.creationTime) {
                                const date = new Date(user.metadata.creationTime);
                                profileCreated.textContent = date.toLocaleDateString('es-ES');
                            } else {
                                profileCreated.textContent = 'No disponible';
                            }
                        }
                    }
                } catch (error) {
                    console.warn('No se pudo cargar información adicional:', error);
                    if (profileCreated) {
                        profileCreated.textContent = 'No disponible';
                    }
                }
            } catch (error) {
                console.error('Error en updateUserInfo:', error);
            }
        }

        // Inicializar carga de información del usuario cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(loadUserInfo, 100);
            });
        } else {
            setTimeout(loadUserInfo, 100);
        }

        // Función para alternar entre modo vista y edición
        function toggleEditMode() {
            const editForm = document.getElementById('profile-edit-form');
            const infoView = document.getElementById('profile-info-view');
            const editBtn = document.getElementById('edit-profile-btn');
            
            if (editForm.classList.contains('hidden')) {
                // Cambiar a modo edición
                editForm.classList.remove('hidden');
                infoView.classList.add('hidden');
                editBtn.innerHTML = '<i class="fas fa-times mr-2"></i>Cancelar';
                editBtn.onclick = function() { toggleEditMode(); };
                
                // Cargar datos en el formulario
                loadEditForm();
            } else {
                // Cambiar a modo vista
                editForm.classList.add('hidden');
                infoView.classList.remove('hidden');
                editBtn.innerHTML = '<i class="fas fa-edit mr-2"></i>Editar';
                editBtn.onclick = function() { toggleEditMode(); };
            }
        }

        // Cargar formulario de edición
        async function loadEditForm() {
            console.log('loadEditForm llamado');
            
            // Esperar a que auth y db estén disponibles
            if (typeof auth === 'undefined' || typeof db === 'undefined') {
                console.log('Esperando Firebase...');
                setTimeout(loadEditForm, 200);
                return;
            }
            
            // Obtener el usuario actual de Firebase Auth
            let user = currentUser;
            if (!user && auth.currentUser) {
                user = auth.currentUser;
                currentUser = user;
            }
            
            if (!user) {
                console.log('Esperando usuario autenticado...');
                setTimeout(loadEditForm, 200);
                return;
            }
            
            console.log('Usuario encontrado:', user.email);
            
            // Asegurarse de que userData esté cargado
            if (!userData || Object.keys(userData).length === 0) {
                try {
                    console.log('Cargando datos de Firestore...');
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        userData = userDoc.data();
                        console.log('Datos cargados:', userData);
                    } else {
                        console.log('No se encontró documento en Firestore');
                        userData = {};
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    userData = {};
                }
            }
            
            // Llenar el formulario con los datos actuales
            const editFullname = document.getElementById('edit-fullname');
            const editEmail = document.getElementById('edit-email');
            const editPhone = document.getElementById('edit-phone');
            const editAddress = document.getElementById('edit-address');
            
            console.log('Llenando formulario...', {
                editFullname: !!editFullname,
                editEmail: !!editEmail,
                editPhone: !!editPhone,
                editAddress: !!editAddress
            });
            
            if (editFullname) {
                editFullname.value = user.displayName || userData.fullName || userData.name || '';
                console.log('Nombre completo:', editFullname.value);
            }
            if (editEmail) {
                editEmail.value = user.email || '';
                console.log('Email:', editEmail.value);
            }
            if (editPhone) {
                editPhone.value = userData.phone || '';
                console.log('Teléfono:', editPhone.value);
            }
            if (editAddress) {
                editAddress.value = userData.address || '';
                console.log('Dirección:', editAddress.value);
            }
            
            console.log('Formulario cargado correctamente');
        }

        // Manejar envío del formulario de edición
        function initEditForm() {
            const editForm = document.getElementById('profile-edit-form');
            if (!editForm) {
                console.log('Formulario no encontrado, reintentando...');
                setTimeout(initEditForm, 100);
                return;
            }

            // Remover listener anterior si existe
            const newEditForm = editForm.cloneNode(true);
            editForm.parentNode.replaceChild(newEditForm, editForm);

            document.getElementById('profile-edit-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Formulario enviado');
            
            // Asegurarse de que currentUser esté disponible
            if (!currentUser && auth && auth.currentUser) {
                currentUser = auth.currentUser;
            }
            
            if (!currentUser) {
                alert('No hay usuario autenticado. Por favor, inicia sesión nuevamente.');
                return;
            }
            
            // Asegurarse de que db esté disponible
            if (typeof db === 'undefined') {
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    db = firebase.firestore();
                } else {
                    alert('Error: Firebase no está disponible. Recarga la página.');
                    return;
                }
            }

            const messageDiv = document.getElementById('edit-profile-message');
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

            try {
                const fullName = document.getElementById('edit-fullname').value.trim();
                const email = document.getElementById('edit-email').value.trim();
                const phone = document.getElementById('edit-phone').value.trim();
                const address = document.getElementById('edit-address').value.trim();

                // Actualizar displayName en Firebase Auth
                await currentUser.updateProfile({
                    displayName: fullName
                });

                // Actualizar email si cambió
                if (email !== currentUser.email) {
                    await currentUser.updateEmail(email);
                }

                // Actualizar información en Firestore
                const updateData = {
                    fullName: fullName,
                    email: email,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (phone) updateData.phone = phone;
                if (address) updateData.address = address;

                await db.collection('users').doc(currentUser.uid).set(updateData, { merge: true });

                // Actualizar datos locales
                userData = { ...userData, ...updateData };

                // Mostrar mensaje de éxito
                messageDiv.className = 'p-4 rounded-lg bg-green-100 text-green-700 border border-green-200';
                messageDiv.textContent = 'Perfil actualizado exitosamente';
                messageDiv.classList.remove('hidden');

                // Actualizar información en la pestaña de información
                document.getElementById('profile-name').textContent = fullName;
                document.getElementById('profile-fullname').textContent = fullName;
                document.getElementById('profile-email').textContent = email;
                document.getElementById('profile-email-detail').textContent = email;
                if (phone) {
                    document.getElementById('profile-phone').textContent = phone;
                }
                if (address) {
                    document.getElementById('profile-address').textContent = address;
                }
                
                // Recargar información del usuario para asegurar que todo esté actualizado
                updateUserInfo(currentUser);
                
                // Volver a modo vista
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                    toggleEditMode();
                }, 2000);

            } catch (error) {
                console.error('Error al actualizar perfil:', error);
                messageDiv.className = 'p-4 rounded-lg bg-red-100 text-red-700 border border-red-200';
                messageDiv.textContent = 'Error al actualizar el perfil: ' + (error.message || 'Error desconocido');
                messageDiv.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        });
        }


        // Inicializar formulario de edición cuando el DOM esté listo
        function initializeProfile() {
            console.log('Inicializando perfil...');
            
            // Asegurarse de que currentUser esté disponible
            if (typeof auth !== 'undefined' && auth.currentUser) {
                currentUser = auth.currentUser;
                console.log('Usuario actual establecido:', currentUser.email);
            }
            
            initEditForm();
            loadUserInfo();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeProfile);
        } else {
            initializeProfile();
        }
    </script>
    {% include 'partials/footer.html' %}
</body>
</html>

