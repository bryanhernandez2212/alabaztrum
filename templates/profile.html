<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - ALABAZTRUM</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body class="bg-white profile-page">
    {% include 'partials/navbar.html' %}

    <!-- Área principal -->
    <main class="min-h-screen bg-gray-50 py-6 md:py-12">
        <div class="container mx-auto px-4">
            <div class="max-w-6xl mx-auto">
                <!-- Navegación de Pestañas -->
                <div class="flex border-b border-gray-200 mb-8 overflow-x-auto">
                    <button onclick="showTab('profile')" id="tab-btn-profile"
                        class="px-6 py-3 text-gray-900 border-b-2 border-gray-900 font-medium text-sm focus:outline-none transition-colors whitespace-nowrap">
                        <i class="far fa-user mr-2"></i>Mi Perfil
                    </button>
                    <button onclick="showTab('orders')" id="tab-btn-orders"
                        class="px-6 py-3 text-gray-500 border-b-2 border-transparent hover:text-gray-700 font-medium text-sm focus:outline-none transition-colors whitespace-nowrap">
                        <i class="fas fa-shopping-bag mr-2"></i>Mis Pedidos
                    </button>
                    <button onclick="showTab('reviews')" id="tab-btn-reviews"
                        class="px-6 py-3 text-gray-500 border-b-2 border-transparent hover:text-gray-700 font-medium text-sm focus:outline-none transition-colors whitespace-nowrap">
                        <i class="fas fa-star mr-2"></i>Mis Reseñas de Sitio
                    </button>
                </div>

                <!-- Pestaña: Perfil (Contenido Original) -->
                <div id="tab-content-profile" class="tab-content">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="text-center mb-6">
                            <div
                                class="w-24 h-24 bg-gray-300 rounded-full mx-auto mb-4 flex items-center justify-center">
                                <i class="far fa-user text-4xl text-gray-600"></i>
                            </div>
                            <h2 id="profile-name" class="text-2xl font-bold text-gray-800 mb-2">Cargando...</h2>
                            <p id="profile-email" class="text-gray-600 mb-6">Cargando...</p>
                        </div>

                        <div class="border-t pt-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-gray-800">Información de la cuenta</h3>
                                <button id="edit-profile-btn" onclick="toggleEditMode()"
                                    class="px-4 py-2 bg-gray-900 hover:bg-gray-800 text-white text-sm font-medium rounded-lg transition">
                                    <i class="fas fa-edit mr-2"></i>Editar
                                </button>
                            </div>

                            <form id="profile-edit-form" class="space-y-4 hidden">
                                <div>
                                    <label for="edit-fullname" class="block text-sm font-medium text-gray-700 mb-1">
                                        Nombre completo <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="edit-fullname" name="fullname" required
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900">
                                </div>
                                <div>
                                    <label for="edit-email" class="block text-sm font-medium text-gray-700 mb-1">
                                        Correo electrónico <span class="text-red-500">*</span>
                                    </label>
                                    <input type="email" id="edit-email" name="email" required
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900">
                                </div>
                                <div>
                                    <label for="edit-phone"
                                        class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                                    <input type="tel" id="edit-phone" name="phone"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900"
                                        placeholder="+52 123 456 7890">
                                </div>
                                <div>
                                    <label for="edit-address"
                                        class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                                    <textarea id="edit-address" name="address" rows="3"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 resize-none"
                                        placeholder="Tu dirección completa"></textarea>
                                </div>

                                <!-- Mensaje de éxito/error -->
                                <div id="edit-profile-message" class="hidden p-4 rounded-lg"></div>

                                <!-- Botones -->
                                <div class="flex items-center justify-end space-x-4 pt-4 border-t border-gray-200">
                                    <button type="button" onclick="toggleEditMode()"
                                        class="px-6 py-2 text-gray-700 hover:text-gray-900 transition font-medium">
                                        Cancelar
                                    </button>
                                    <button type="submit"
                                        class="bg-gray-900 hover:bg-gray-800 text-white font-semibold py-2 px-6 rounded-lg transition">
                                        Guardar Cambios
                                    </button>
                                </div>
                            </form>

                            <div id="profile-info-view" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre completo</label>
                                    <p id="profile-fullname" class="text-gray-900">-</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Correo
                                        electrónico</label>
                                    <p id="profile-email-detail" class="text-gray-900">-</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                                    <p id="profile-phone" class="text-gray-900">-</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
                                    <p id="profile-address" class="text-gray-900">-</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de
                                        registro</label>
                                    <p id="profile-created" class="text-gray-900">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pestaña: Pedidos (Placeholder) -->
                <div id="tab-content-orders" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow-md p-6 text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                            <i class="fas fa-shopping-bag text-3xl text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Aún no tienes pedidos</h3>
                        <p class="text-gray-500 mb-6">Cuando realices compras, aparecerán aquí.</p>
                        <a href="/fragancias"
                            class="px-6 py-2 bg-gray-900 hover:bg-gray-800 text-white font-semibold rounded-lg transition">
                            Ir a comprar
                        </a>
                    </div>
                </div>

                <!-- Pestaña: Reseñas -->
                <div id="tab-content-reviews" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-900">Mis Reseñas del Sitio</h2>
                            <button onclick="toggleReviewForm()"
                                class="px-4 py-2 bg-gray-900 hover:bg-gray-800 text-white text-sm font-medium rounded-lg transition">
                                <i class="fas fa-plus mr-2"></i>Nueva Reseña
                            </button>
                        </div>

                        <!-- Formulario de Reseña -->
                        <div id="review-form-container"
                            class="hidden mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200 fade-in">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Escribir reseña sobre ALABAZTRUM</h3>
                            <form id="site-review-form" onsubmit="handleReviewSubmit(event)">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Calificación</label>
                                    <div class="flex items-center gap-2" id="site-rating-stars">
                                        <i class="fas fa-star text-gray-300 text-2xl cursor-pointer site-rating-star hover:scale-110 transition-transform"
                                            data-rating="1"></i>
                                        <i class="fas fa-star text-gray-300 text-2xl cursor-pointer site-rating-star hover:scale-110 transition-transform"
                                            data-rating="2"></i>
                                        <i class="fas fa-star text-gray-300 text-2xl cursor-pointer site-rating-star hover:scale-110 transition-transform"
                                            data-rating="3"></i>
                                        <i class="fas fa-star text-gray-300 text-2xl cursor-pointer site-rating-star hover:scale-110 transition-transform"
                                            data-rating="4"></i>
                                        <i class="fas fa-star text-gray-300 text-2xl cursor-pointer site-rating-star hover:scale-110 transition-transform"
                                            data-rating="5"></i>
                                    </div>
                                    <input type="hidden" id="site-rating-input" name="rating" value="0">
                                </div>
                                <div class="mb-4">
                                    <label for="review-title"
                                        class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                                    <input type="text" id="review-title" name="title"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900"
                                        placeholder="Resumen de tu experiencia">
                                </div>
                                <div class="mb-6">
                                    <label for="review-text"
                                        class="block text-sm font-medium text-gray-700 mb-1">Comentario</label>
                                    <textarea id="review-text" name="review" rows="4"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-gray-900 resize-none"
                                        placeholder="Cuéntanos qué te pareció el sitio y el servicio..."></textarea>
                                </div>
                                <div id="review-message" class="hidden mb-4 p-3 rounded-lg text-sm"></div>
                                <div class="flex justify-end space-x-3">
                                    <button type="button" onclick="toggleReviewForm()"
                                        class="px-6 py-2 text-gray-600 hover:text-gray-900 font-medium text-sm">Cancelar</button>
                                    <button type="submit"
                                        class="px-6 py-2 bg-gray-900 hover:bg-gray-800 text-white font-medium text-sm rounded-lg transition shadow-md hover:shadow-lg">Publicar
                                        Reseña</button>
                                </div>
                            </form>
                        </div>

                        <!-- Lista de Reseñas -->
                        <div id="user-reviews-list" class="space-y-4">
                            <div class="text-center py-12 text-gray-500">
                                <div
                                    class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mb-3">
                                </div>
                                <p>Cargando tus reseñas...</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
    </main>

    <!-- Scripts Firebase y autenticación -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="{{ url_for('static', filename='js/firebase-config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/navbar-auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/navbar-persistent.js') }}"></script>

    <script>
        if (typeof currentUser === 'undefined') {
            var currentUser = null;
        }
        let userData = {};
        let selectedSiteRating = 0;

        // Función para cambiar pestañas
        function showTab(tabName) {
            // Actualizar botones
            ['profile', 'orders', 'reviews'].forEach(tab => {
                const btn = document.getElementById(`tab-btn-${tab}`);
                const content = document.getElementById(`tab-content-${tab}`);

                if (tab === tabName) {
                    btn.classList.remove('text-gray-500', 'border-transparent');
                    btn.classList.add('text-gray-900', 'border-gray-900');
                    content.classList.remove('hidden');
                } else {
                    btn.classList.add('text-gray-500', 'border-transparent');
                    btn.classList.remove('text-gray-900', 'border-gray-900');
                    content.classList.add('hidden');
                }
            });

            // Si es la pestaña de reseñas, cargar las reseñas
            if (tabName === 'reviews') {
                loadUserReviews();
            }

            // Actualizar URL sin recargar
            const url = new URL(window.location);
            url.searchParams.set('tab', tabName);
            window.history.pushState({}, '', url);
        }

        // Toggle formulario de reseña
        function toggleReviewForm() {
            const formContainer = document.getElementById('review-form-container');
            const isHidden = formContainer.classList.contains('hidden');

            if (isHidden) {
                formContainer.classList.remove('hidden');
                // Reset form
                document.getElementById('site-review-form').reset();
                selectedSiteRating = 0;
                document.getElementById('site-rating-input').value = 0;
                updateSiteStars(0);
            } else {
                formContainer.classList.add('hidden');
            }
        }

        // Sistema de estrellas para reseña del sitio
        document.querySelectorAll('.site-rating-star').forEach(star => {
            star.addEventListener('click', function () {
                const rating = parseInt(this.getAttribute('data-rating'));
                selectedSiteRating = rating;
                document.getElementById('site-rating-input').value = rating;
                updateSiteStars(rating);
            });

            star.addEventListener('mouseenter', function () {
                const rating = parseInt(this.getAttribute('data-rating'));
                updateSiteStars(rating, true);
            });
        });

        document.getElementById('site-rating-stars').addEventListener('mouseleave', function () {
            updateSiteStars(selectedSiteRating);
        });

        function updateSiteStars(rating, isHover = false) {
            document.querySelectorAll('.site-rating-star').forEach((s, i) => {
                if (i < rating) {
                    s.classList.remove('text-gray-300');
                    s.classList.add(isHover ? 'text-yellow-300' : 'text-yellow-400');
                } else {
                    s.classList.remove('text-yellow-400', 'text-yellow-300');
                    s.classList.add('text-gray-300');
                }
            });
        }

        // Manejar envío de reseña
        async function handleReviewSubmit(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            const messageDiv = document.getElementById('review-message');

            const rating = parseInt(document.getElementById('site-rating-input').value);
            const title = document.getElementById('review-title').value.trim();
            const review = document.getElementById('review-text').value.trim();

            if (rating === 0) {
                showMessage(messageDiv, 'Por favor selecciona una calificación', 'error');
                return;
            }
            if (!title) {
                showMessage(messageDiv, 'Por favor escribe un título', 'error');
                return;
            }
            if (!review) {
                showMessage(messageDiv, 'Por favor escribe tu comentario', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Publicando...'; // Fixed spinner icon class

            try {
                if (!auth.currentUser) throw new Error('Debes iniciar sesión');

                // Obtener nombre del usuario si no está disponible, intentar obtenerlo de Firestore
                let userName = auth.currentUser.displayName;
                if (!userName) {
                    const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
                    if (userDoc.exists) {
                        userName = userDoc.data().fullName || auth.currentUser.email.split('@')[0];
                    } else {
                        userName = auth.currentUser.email.split('@')[0];
                    }
                }

                await db.collection('siteReviews').add({
                    userId: auth.currentUser.uid,
                    userName: userName,
                    rating: rating,
                    title: title,
                    review: review,
                    approved: false, // Requiere aprobación del admin
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showMessage(messageDiv, '¡Reseña enviada! Pendiente de aprobación.', 'success');
                setTimeout(() => {
                    toggleReviewForm();
                    loadUserReviews();
                    messageDiv.classList.add('hidden');
                }, 2000);

            } catch (error) {
                console.error('Error:', error);
                showMessage(messageDiv, 'Error al publicar la reseña: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        function showMessage(div, text, type) {
            div.textContent = text;
            div.className = `mb-4 p-3 rounded-lg text-sm ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            div.classList.remove('hidden');
        }

        // Cargar reseñas del usuario
        async function loadUserReviews() {
            const container = document.getElementById('user-reviews-list');

            if (!auth.currentUser) return;

            try {
                // Quitamos orderBy para evitar erro de índice compuesto
                const snapshot = await db.collection('siteReviews')
                    .where('userId', '==', auth.currentUser.uid)
                    .get();

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <i class="far fa-comment-dots text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">No has escrito reseñas aún.</p>
                        </div>
                    `;
                    return;
                }

                // Ordenar en cliente
                const reviews = [];
                snapshot.forEach(doc => {
                    reviews.push({ id: doc.id, ...doc.data() });
                });

                reviews.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA; // Descendente
                });

                container.innerHTML = reviews.map(data => {
                    const date = data.createdAt ? data.createdAt.toDate().toLocaleDateString() : 'Reciente';
                    const stars = Array(5).fill(0).map((_, i) =>
                        `<i class="${i < data.rating ? 'fas' : 'far'} fa-star text-yellow-400 text-xs"></i>`
                    ).join('');

                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-bold text-gray-900">${data.title}</h4>
                                    <div class="flex items-center gap-2 mt-1">
                                        <div class="flex text-yellow-400">${stars}</div>
                                        <span class="text-xs text-gray-500">• ${date}</span>
                                    </div>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-full font-medium ${data.approved
                            ? 'bg-green-100 text-green-800'
                            : 'bg-yellow-100 text-yellow-800'
                        }">
                                    ${data.approved ? 'Aprobada' : 'Pendiente'}
                                </span>
                            </div>
                            <p class="text-gray-600 text-sm italic">"${data.review}"</p>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading reviews:', error);

                // Mostrar el error real en la UI para depuración si es necesario
                container.innerHTML = `
                    <div class="text-center py-4 bg-red-50 text-red-600 rounded-lg">
                        <p class="font-bold">Error al cargar reseñas</p>
                        <p class="text-sm">${error.message}</p>
                    </div>`;
            }
        }

        // Cargar información del perfil
        function loadUserInfo() {
            try {
                // Verificar que Firebase esté disponible
                if (typeof firebase === 'undefined') {
                    console.log('Esperando Firebase...');
                    setTimeout(loadUserInfo, 500);
                    return;
                }

                const auth = firebase.auth();

                if (!auth) {
                    console.log('Esperando auth...');
                    setTimeout(loadUserInfo, 500);
                    return;
                }

                // Obtener usuario actual directamente primero
                const currentUserAuth = auth.currentUser;
                if (currentUserAuth) {
                    updateUserInfo(currentUserAuth);
                }

                // También escuchar cambios de autenticación
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        updateUserInfo(user);

                        // Check tab from URL
                        const urlParams = new URLSearchParams(window.location.search);
                        const tab = urlParams.get('tab');
                        if (tab) {
                            showTab(tab);
                        }
                    } else {
                        // Usuario no autenticado, redirigir al login
                        window.location.href = '/login';
                    }
                });
            } catch (error) {
                console.error('Error en loadUserInfo:', error);
            }
        }

        // Función para actualizar la información del usuario
        async function updateUserInfo(user) {
            try {
                currentUser = user;

                // Verificar que db esté disponible
                if (typeof db === 'undefined') {
                    // Intentar obtener db de firebase
                    if (typeof firebase !== 'undefined' && firebase.firestore) {
                        db = firebase.firestore();
                    } else {
                        setTimeout(() => updateUserInfo(user), 500);
                        return;
                    }
                }

                // Mostrar información básica inmediatamente
                const profileName = document.getElementById('profile-name');
                const profileEmail = document.getElementById('profile-email');
                const profileEmailDetail = document.getElementById('profile-email-detail');
                const profileFullname = document.getElementById('profile-fullname');
                const profilePhone = document.getElementById('profile-phone');
                const profileAddress = document.getElementById('profile-address');
                const profileCreated = document.getElementById('profile-created');

                if (profileName) {
                    profileName.textContent = user.displayName || user.email?.split('@')[0] || 'Usuario';
                }
                if (profileEmail) {
                    profileEmail.textContent = user.email || 'No disponible';
                }
                if (profileEmailDetail) {
                    profileEmailDetail.textContent = user.email || 'No disponible';
                }
                if (profileFullname) {
                    profileFullname.textContent = user.displayName || user.email?.split('@')[0] || '-';
                }
                if (profilePhone) {
                    profilePhone.textContent = '-';
                }
                if (profileAddress) {
                    profileAddress.textContent = '-';
                }

                // Intentar obtener información adicional de Firestore
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        userData = userDoc.data();
                        if (userData.fullName && profileFullname) {
                            profileFullname.textContent = userData.fullName;
                        }
                        if (userData.fullName && profileName) {
                            profileName.textContent = userData.fullName;
                        }
                        if (userData.phone && profilePhone) {
                            profilePhone.textContent = userData.phone;
                        }
                        if (userData.address && profileAddress) {
                            profileAddress.textContent = userData.address;
                        }
                        if (userData.createdAt && profileCreated) {
                            const date = userData.createdAt.toDate();
                            profileCreated.textContent = date.toLocaleDateString('es-ES');
                        } else if (profileCreated) {
                            profileCreated.textContent = 'No disponible';
                        }
                    } else {
                        // Si no existe el documento, usar la fecha de creación de auth
                        if (profileCreated) {
                            if (user.metadata && user.metadata.creationTime) {
                                const date = new Date(user.metadata.creationTime);
                                profileCreated.textContent = date.toLocaleDateString('es-ES');
                            } else {
                                profileCreated.textContent = 'No disponible';
                            }
                        }
                    }
                } catch (error) {
                    console.warn('No se pudo cargar información adicional:', error);
                    if (profileCreated) {
                        profileCreated.textContent = 'No disponible';
                    }
                }
            } catch (error) {
                console.error('Error en updateUserInfo:', error);
            }
        }

        // Inicializar carga de información del usuario cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                setTimeout(loadUserInfo, 100);
            });
        } else {
            setTimeout(loadUserInfo, 100);
        }

        // Función para alternar entre modo vista y edición
        function toggleEditMode() {
            const editForm = document.getElementById('profile-edit-form');
            const infoView = document.getElementById('profile-info-view');
            const editBtn = document.getElementById('edit-profile-btn');

            if (editForm.classList.contains('hidden')) {
                // Cambiar a modo edición
                editForm.classList.remove('hidden');
                infoView.classList.add('hidden');
                editBtn.innerHTML = '<i class="fas fa-times mr-2"></i>Cancelar';
                editBtn.onclick = function () { toggleEditMode(); };

                // Cargar datos en el formulario
                loadEditForm();
            } else {
                // Cambiar a modo vista
                editForm.classList.add('hidden');
                infoView.classList.remove('hidden');
                editBtn.innerHTML = '<i class="fas fa-edit mr-2"></i>Editar';
                editBtn.onclick = function () { toggleEditMode(); };
            }
        }

        // Cargar formulario de edición
        async function loadEditForm() {
            console.log('loadEditForm llamado');

            // Esperar a que auth y db estén disponibles
            if (typeof auth === 'undefined' || typeof db === 'undefined') {
                console.log('Esperando Firebase...');
                setTimeout(loadEditForm, 200);
                return;
            }

            // Obtener el usuario actual de Firebase Auth
            let user = currentUser;
            if (!user && auth.currentUser) {
                user = auth.currentUser;
                currentUser = user;
            }

            if (!user) {
                console.log('Esperando usuario autenticado...');
                setTimeout(loadEditForm, 200);
                return;
            }

            console.log('Usuario encontrado:', user.email);

            // Asegurarse de que userData esté cargado
            if (!userData || Object.keys(userData).length === 0) {
                try {
                    console.log('Cargando datos de Firestore...');
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        userData = userDoc.data();
                        console.log('Datos cargados:', userData);
                    } else {
                        console.log('No se encontró documento en Firestore');
                        userData = {};
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    userData = {};
                }
            }

            // Llenar el formulario con los datos actuales
            const editFullname = document.getElementById('edit-fullname');
            const editEmail = document.getElementById('edit-email');
            const editPhone = document.getElementById('edit-phone');
            const editAddress = document.getElementById('edit-address');

            console.log('Llenando formulario...', {
                editFullname: !!editFullname,
                editEmail: !!editEmail,
                editPhone: !!editPhone,
                editAddress: !!editAddress
            });

            if (editFullname) {
                editFullname.value = user.displayName || userData.fullName || userData.name || '';
                console.log('Nombre completo:', editFullname.value);
            }
            if (editEmail) {
                editEmail.value = user.email || '';
                console.log('Email:', editEmail.value);
            }
            if (editPhone) {
                editPhone.value = userData.phone || '';
                console.log('Teléfono:', editPhone.value);
            }
            if (editAddress) {
                editAddress.value = userData.address || '';
                console.log('Dirección:', editAddress.value);
            }

            console.log('Formulario cargado correctamente');
        }

        // Manejar envío del formulario de edición
        function initEditForm() {
            const editForm = document.getElementById('profile-edit-form');
            if (!editForm) {
                console.log('Formulario no encontrado, reintentando...');
                setTimeout(initEditForm, 100);
                return;
            }

            // Remover listener anterior si existe
            const newEditForm = editForm.cloneNode(true);
            editForm.parentNode.replaceChild(newEditForm, editForm);

            document.getElementById('profile-edit-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                console.log('Formulario enviado');

                // Asegurarse de que currentUser esté disponible
                if (!currentUser && auth && auth.currentUser) {
                    currentUser = auth.currentUser;
                }

                if (!currentUser) {
                    alert('No hay usuario autenticado. Por favor, inicia sesión nuevamente.');
                    return;
                }

                // Asegurarse de que db esté disponible
                if (typeof db === 'undefined') {
                    if (typeof firebase !== 'undefined' && firebase.firestore) {
                        db = firebase.firestore();
                    } else {
                        alert('Error: Firebase no está disponible. Recarga la página.');
                        return;
                    }
                }

                const messageDiv = document.getElementById('edit-profile-message');
                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;

                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

                try {
                    const fullName = document.getElementById('edit-fullname').value.trim();
                    const email = document.getElementById('edit-email').value.trim();
                    const phone = document.getElementById('edit-phone').value.trim();
                    const address = document.getElementById('edit-address').value.trim();

                    // Actualizar displayName en Firebase Auth
                    await currentUser.updateProfile({
                        displayName: fullName
                    });

                    // Actualizar email si cambió
                    if (email !== currentUser.email) {
                        await currentUser.updateEmail(email);
                    }

                    // Actualizar información en Firestore
                    const updateData = {
                        fullName: fullName,
                        email: email,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    if (phone) updateData.phone = phone;
                    if (address) updateData.address = address;

                    await db.collection('users').doc(currentUser.uid).set(updateData, { merge: true });

                    // Actualizar datos locales
                    userData = { ...userData, ...updateData };

                    // Mostrar mensaje de éxito
                    messageDiv.className = 'p-4 rounded-lg bg-green-100 text-green-700 border border-green-200';
                    messageDiv.textContent = 'Perfil actualizado exitosamente';
                    messageDiv.classList.remove('hidden');

                    // Actualizar información en la pestaña de información
                    document.getElementById('profile-name').textContent = fullName;
                    document.getElementById('profile-fullname').textContent = fullName;
                    document.getElementById('profile-email').textContent = email;
                    document.getElementById('profile-email-detail').textContent = email;
                    if (phone) {
                        document.getElementById('profile-phone').textContent = phone;
                    }
                    if (address) {
                        document.getElementById('profile-address').textContent = address;
                    }

                    // Recargar información del usuario para asegurar que todo esté actualizado
                    updateUserInfo(currentUser);

                    // Volver a modo vista
                    setTimeout(() => {
                        messageDiv.classList.add('hidden');
                        toggleEditMode();
                    }, 2000);

                } catch (error) {
                    console.error('Error al actualizar perfil:', error);
                    messageDiv.className = 'p-4 rounded-lg bg-red-100 text-red-700 border border-red-200';
                    messageDiv.textContent = 'Error al actualizar el perfil: ' + (error.message || 'Error desconocido');
                    messageDiv.classList.remove('hidden');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            });
        }


        // Inicializar formulario de edición cuando el DOM esté listo
        function initializeProfile() {
            console.log('Inicializando perfil...');

            // Asegurarse de que currentUser esté disponible
            if (typeof auth !== 'undefined' && auth.currentUser) {
                currentUser = auth.currentUser;
                console.log('Usuario actual establecido:', currentUser.email);
            }

            initEditForm();
            loadUserInfo();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeProfile);
        } else {
            initializeProfile();
        }
    </script>
    {% include 'partials/footer.html' %}
</body>

</html>